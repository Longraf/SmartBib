window.DEBUG = true;
window.isMobile = false;
let DocumentPerf = window.performance.now();

let CustomSvg = `<svg
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   version="1.1"
   id="Слой_1"
   x="0px"
   y="0px"
   width="60"
   height="60"
   viewBox="0 0 60.000001 60"
   enable-background="new 0 0 115.5 64"
   xml:space="preserve"
   sodipodi:docname="gear1.svg"
   inkscape:version="0.92.3 (2405546, 2018-03-11)"><metadata
   id="metadata45"><rdf:RDF><cc:Work
       rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type
         rdf:resource="http://purl.org/dc/dcmitype/StillImage" /><dc:title></dc:title></cc:Work></rdf:RDF></metadata><defs
   id="defs43" /><sodipodi:namedview
   pagecolor="#ffffff"
   bordercolor="#666666"
   borderopacity="1"
   objecttolerance="10"
   gridtolerance="10"
   guidetolerance="10"
   inkscape:pageopacity="0"
   inkscape:pageshadow="2"
   inkscape:window-width="1615"
   inkscape:window-height="837"
   id="namedview41"
   showgrid="false"
   inkscape:zoom="9.3056477"
   inkscape:cx="19.215939"
   inkscape:cy="30.67169"
   inkscape:window-x="0"
   inkscape:window-y="0"
   inkscape:window-maximized="0"
   inkscape:current-layer="Слой_1"
   units="px"
   width="60in" />

<path class="custom-load-pass"
   inkscape:connector-curvature="0"
   d="m 54.836173,44.863545 c -3.364843,3.364843 -6.59672,6.594007 -9.828597,9.82317 -0.179097,0.179097 -0.366334,0.344625 -0.708246,0.664828 -1.245534,-1.275384 -2.569763,-2.46122 -3.679618,-3.820725 -1.017594,-1.242821 -1.856091,-0.238795 -2.78685,-0.04613 -0.898196,0.184524 -0.69739,0.868347 -0.700104,1.454481 -0.0081,1.660713 -0.0027,3.321425 -0.0027,5.060832 -4.936007,0 -9.774325,0 -14.767318,0 0,-1.750261 -0.03799,-3.4761 0.01628,-5.201938 0.02442,-0.762517 -0.227941,-1.085434 -0.933472,-1.432772 -1.280812,-0.626838 -2.157299,-0.447741 -3.052781,0.664828 -0.947041,1.177695 -2.056896,2.225138 -3.066349,3.294289 C 11.739049,51.712628 8.3226482,48.274519 4.8194126,44.744147 6.0188163,43.550171 7.269778,42.19338 8.6401374,40.974981 9.7635607,39.976382 8.6564189,39.222006 8.5261669,38.364514 8.4121964,37.620992 7.8477712,37.653555 7.2833459,37.656269 c -1.736693,0 -3.4706725,0 -5.2833459,0 0,-4.949575 0,-9.793321 0,-14.802595 1.6715671,0 3.3621292,0.02714 5.0499778,0 0.5617117,0 1.2889519,0.282213 1.4734755,-0.656687 C 8.7052634,21.277082 9.7527064,20.452153 8.512599,19.431846 7.1530939,18.311136 5.961831,16.989621 4.7461459,15.801072 8.2927988,12.257133 11.720054,8.8298777 15.293842,5.256089 c 1.193977,1.2373938 2.472074,2.5154913 3.693186,3.8478605 0.510154,0.553571 0.933473,0.7055316 1.671568,0.3717609 1.687848,-0.7625168 1.706843,-0.7136723 1.709557,-2.6267483 0,-1.3405099 0.0081,-2.6837335 0.01628,-4.0242434 0,-0.070553 0.03256,-0.1411063 0.07055,-0.3039213 4.813897,0 9.652215,0 14.677771,0 0,1.6688535 -0.01628,3.3539885 0.01085,5.0391235 0.0081,0.442314 0.0081,1.1207097 0.263218,1.2753839 0.697391,0.4178918 1.519606,0.6539735 2.314686,0.865633 0.165529,0.043417 0.458596,-0.3012077 0.659401,-0.5020129 1.305233,-1.3025198 2.602326,-2.6131803 3.864142,-3.8858507 3.492381,3.5086627 6.908782,6.9440588 10.450008,10.5042798 -1.199404,1.185835 -2.447652,2.5372 -3.826152,3.74203 -1.131564,0.987745 -0.04342,1.742121 0.07869,2.596899 0.122111,0.846638 0.76523,0.702818 1.332369,0.702818 1.701416,0 3.402833,0 5.196511,0 0,4.92244 0,9.790607 0,14.799882 -1.755688,0 -3.48424,0 -5.215506,0 -0.607843,0 -1.204831,-0.02714 -1.324229,0.762516 -0.130252,0.854779 -1.231966,1.606441 -0.07598,2.596899 1.3785,1.177695 2.610467,2.518205 3.975399,3.856001 z M 14.740271,19.016668 c -1.017593,2.851976 -1.896794,5.36204 -2.83298,7.850395 -0.100402,0.263218 -0.542716,0.54543 -0.838497,0.561712 -1.229253,0.06513 -2.4666468,0 -3.6958998,0.05698 -0.3012077,0.02714 -0.8384972,0.322917 -0.8466379,0.512867 -0.06784,1.652572 -0.03799,3.310571 -0.03799,5.087968 1.8588043,0 3.5819297,0 5.0255557,0 1.120709,2.843835 2.162725,5.484151 3.30243,8.379544 -1.066439,1.031162 -2.309259,2.233279 -3.448964,3.334994 1.288952,1.30252 2.553481,2.580617 3.980826,4.02153 1.115282,-1.253676 2.265842,-2.545341 3.131474,-3.522231 2.887253,1.017594 5.402745,1.88594 7.893814,2.813985 0.252363,0.09498 0.502013,0.561712 0.512867,0.865633 0.05156,1.473476 0.02442,2.949665 0.02442,4.458417 1.956493,0 3.774594,0 5.676816,0 0,-1.424631 0.07327,-2.767854 -0.02442,-4.09751 -0.07055,-0.9389 0.328344,-1.207544 1.145132,-1.44634 1.625436,-0.47759 3.21831,-1.071865 4.800328,-1.687848 0.724527,-0.282213 1.383928,-0.732668 2.382526,-1.275384 1.166841,1.267243 2.333682,2.5372 3.364843,3.657909 1.313374,-1.31066 2.580617,-2.57519 4.005248,-3.997107 -1.191262,-1.096288 -2.466646,-2.268555 -3.524944,-3.240018 1.123424,-2.868257 2.157299,-5.511287 3.245445,-8.298137 1.51418,0 3.204742,0 5.025556,0 0,-1.752974 0.02442,-3.410973 -0.03528,-5.066259 -0.0054,-0.18181 -0.483017,-0.480304 -0.754376,-0.491158 -1.229253,-0.05699 -2.466647,0 -3.6959,-0.06241 -0.331057,-0.02714 -0.827642,-0.298494 -0.933472,-0.575279 -0.941613,-2.485642 -1.815387,-4.99842 -2.82484,-7.831401 0.987744,-0.911764 2.260415,-2.084031 3.516804,-3.242731 -1.381214,-1.37036 -2.656598,-2.634889 -4.040525,-4.005249 -0.971463,0.987744 -2.005338,1.994484 -2.979514,3.055495 -0.46945,0.512867 -0.838498,0.58342 -1.470762,0.227941 -1.131564,-0.634979 -2.311973,-1.207545 -3.522231,-1.674281 -1.172268,-0.453168 -2.406948,-0.738095 -3.714895,-1.128851 0,-1.698702 0,-3.3892646 0,-5.1015354 -1.929357,0 -3.744744,0 -5.636112,0 0,1.7665425 0,3.4245414 0,4.7921874 -2.645743,1.150559 -5.109677,2.244133 -7.600746,3.272581 -0.241509,0.100403 -0.740808,-0.11397 -0.966036,-0.336484 -1.050156,-1.039303 -2.048755,-2.13559 -2.974086,-3.115193 -1.449054,1.430058 -2.724437,2.691874 -4.09751,4.045952 1.210258,1.117996 2.482928,2.292977 3.462531,3.199314 z"
   id="path30"
   style="fill:#5c9baa;fill-opacity:1;stroke-width:2.71358299" /><path
   inkscape:connector-curvature="0"
   d="m 29.835933,17.800983 c 6.425765,0 12.371225,5.94546 12.417356,12.425496 0.04342,6.509885 -6.002446,12.566602 -12.539467,12.555748 -6.436619,0 -12.477055,-6.0133 -12.477055,-12.39836 -0.0027,-6.640138 5.940033,-12.577457 12.599166,-12.582884 z m 7.809692,12.485195 c -0.0054,-4.621232 -3.26444,-7.926376 -7.8314,-7.939944 -4.651081,-0.02714 -7.969794,3.283435 -7.969794,7.918235 0.0027,4.661936 3.264441,7.923662 7.942658,7.945371 4.539824,0.02714 7.863963,-3.33228 7.858536,-7.923662 z"
   id="path32"
   style="fill:#5c9baa;fill-opacity:1;stroke-width:2.71358299" /></svg>`;

// device detection
(function(){
    if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)
        || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))
    {
        //document.head.appendChild(Lure.CreateElementFromString(`<link rel="stylesheet" href="css/mobile.css" type="text/css" />`));
        window.isMobile = true;
    }
    else {
        //document.head.appendChild(Lure.CreateElementFromString(`<link rel="stylesheet" href="css/no-mobile.css" type="text/css" />`));
    }
}());

/* Test LibraryID = 440 */


api.debug = true;
//api.onUnauth = null;
//api.timeout = xxx;
//here 'xxx' in gulpfile (7000 or same value)
api.ontimeout = (method)=>{
    if (method !== 'Cache_GetMasterHistoryLast'){
        Lure.System.Error('Превышено время ожидания ответа сервера. Операция прервана');
    }
};
api.debugExcludes = {
    //key: value,
    //{string} method: {bool} LogIfNotEmpty
    'Cache_GetMasterHistoryLast': true,
    //'Passport_Get': false,
};
Lure.Application.Entry = 'Dash';// Visitation / Bookware / SummaryPart1 / Dash //Account
Lure.Route.Enabled = true;

Lure.Settings.Tutor.Options.Frame.backgroundColor = '';
Lure.Settings.Tutor.Options.Frame.outline = 'none';
Lure.Settings.Content.Permission.Strict = false;
Lure.Settings.Load.Svg = CustomSvg;


let Load = new Lure.Load({BackgroundColor: '#fff'});
window.Load = Load;
Load.Show();

if (window.isMobile){
   //something to do
}
Lure.User.Cache = {
    Libraries: [], //int
    LibraryList:[],
    LibraryListDict:{},
    LibraryGroupList: [], //by LibraryRegionID
    LibraryRegions:[], //int
    WorkingDates: [], // [LastWorkingDayDate, TodayDate]
    Technicians: [],
    TechnicianDict: {},
    UserList: [],

};


window.Global = require('./_common/global');

const Dictionary = require('./_common/dictionary');
window.Dictionary = Dictionary;
window.D = Dictionary;
window.Static = require('./_common/static');


Dictionary.HelpRequestTypeITList = [
    Dictionary.HelpRequestType.IT,
    Dictionary.HelpRequestType.EventTechProvision,
    Dictionary.HelpRequestType.MetersAlarms,
    Dictionary.HelpRequestType.OfficeEquip,
    Dictionary.HelpRequestType.PC,
    Dictionary.HelpRequestType.Software,
    Dictionary.HelpRequestType.WorkingPlace,
];
Dictionary.HelpRequestTypeAHDList = [
    Dictionary.HelpRequestType.AHD,
    Dictionary.HelpRequestType.Repair,
    Dictionary.HelpRequestType.ReplaceInstall,
];

// External plugins
// require('./../js/plugins/ckeditor/ckeditor');

require('./_common/headline/headline');
require('./_common/footer/footer');
let Navigator = require('./_common/navigator/navigator');
let LibraryTree = require('./_common/library-tree/library-tree');
//let InputBox = require('./_common/input-box/input-box'); window.InputBox = InputBox;

window.LibraryTree = LibraryTree;





let Featured = require('./Featured/Featured');
let Dash = require('./Dash/dashboard');

let WDash = require('./WDash/wdashboard');

let DashTester = require('./_DashTester/DashTester');
let Diary = require('./Diary/Diary');
let LibrarySettings = require('./__LibrarySettings/library-settings');
let Passport = require('./Passport/Passport');
let Meter = require('./Meter/Meter');
let DataInput = require('./DataInput/data-input');
let HelpDesk = require('./HelpDesk/HelpDesk');
let Admin = require('./Admin/Admin');
let Testnav = require('./Testnav/Testnav');
let Account = require('./Account/Account');

//window.Passport = Passport;

/**
 * @function Navigator._Init
 */
Navigator._Init();

let HistoryMaster = require('./_common/history-master/history-master');

Lure.Perf(DocumentPerf, "Content Scripts");

(async function StartPoint() {
    if (localStorage.getItem('isActiveNavigator') > 0){
        Navigator.Nav.classList.add('active');
    }
    let GentlePack = await api.GetStartPack({});
    Lure.User.ID          = GentlePack.UserID;
    Lure.User.Name        = GentlePack.UserName;
    Lure.User.Email       = GentlePack.Email;
    Lure.User.Phone       = GentlePack.Phone;
    Lure.User.Position    = GentlePack.Position;
    Lure.User.Roles       = GentlePack.Roles;
    //Lure.User.Roles.push(Dictionary.Role.TesterPanel);

    Lure.User.WebSettings = JSON.parse(GentlePack.WebSettings);
    //Lure.User.SubRoles   = GentlePack.SubRoles;
    for (let r of GentlePack.SubRoles){
        Lure.User.SubRoles[r.Key] = r.Value;
    }
    Lure.User.Cache.LibraryRegions = Lure.User.SubRoles[Dictionary.Role.LibraryRegionID];
    Lure.User.Cache.Libraries = Lure.User.SubRoles[Dictionary.Role.LibraryID];
    Lure.User.Cache.LibraryList  = GentlePack.Libraries.Where(x=>!x.IsVirtual);
    Lure.User.Cache.LibraryFullList  = GentlePack.Libraries;
    Lure.User.Cache.WorkingDates = GentlePack.WorkingDates.Select(x=>Lure.Date(x).Date);

    Lure.User.Cache.LibraryGroupList = [];
    Lure.User.Cache.LibraryListDict = {};
    for (let l of Lure.User.Cache.LibraryFullList){
        Lure.User.Cache.LibraryListDict[l.ID] = l;
    }
    Lure.User.Cache.LibraryListDict[-1] = {ID: -1, Name: 'Все библиотеки'};
    //debugger
    Lure.User.Cache.LibraryGroupList =  Lure.User.Cache.LibraryList
        .GroupBy('LibraryRegionID')
        .Select(x=>{
            return {
                ID: parseInt(x.Key),
                Name: Dictionary.LibraryRegionDict[x.Key],
                isCBS: 1,
                LibraryList: x,
            }
        });

    // * Technicians *
    Lure.User.Cache.Technicians = GentlePack.Technicians;
    for(let t of GentlePack.Technicians){
        Lure.User.Cache.TechnicianDict[t.ID] = t;
    }
    Lure.User.Cache.UserList = GentlePack.UserList;
    Lure.User.Cache.UserDict = Lure.User.Cache.UserList.ToDictionary(x=>x.ID, x=>x);



    //debugger;
    if (Lure.User.ID !== 3 && Lure.User.Roles.indexOf(Dictionary.Role.DairyInput) > -1)
        Lure.Application.Entry = 'Visitation';
    if (Lure.User.ID !== 3 && Lure.User.Roles.indexOf(Dictionary.Role.DairyInput) < 0)
        Lure.Application.Entry = 'Dash';


    Lure.Application.Run();
    HistoryMaster.Run();

    setTimeout(()=>{
        Load.Hide();
        Lure.Perf(DocumentPerf, "Document render done");
    }, 0)

})();
//StartPoint();















